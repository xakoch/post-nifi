events {
    worker_connections 1024;
}

http {
    include       /etc/nginx/mime.types;
    default_type  application/octet-stream;
    
    # Основные настройки
    sendfile        on;
    tcp_nopush     on;
    tcp_nodelay    on;
    keepalive_timeout  65;
    types_hash_max_size 2048;
    
    # Логирование
    access_log  /var/log/nginx/access.log;
    error_log   /var/log/nginx/error.log;
    
    # Gzip сжатие
    gzip on;
    gzip_vary on;
    gzip_min_length 10240;
    gzip_proxied expired no-cache no-store private must-revalidate;
    gzip_types
        text/plain
        text/css
        text/xml
        text/javascript
        application/json
        application/javascript
        application/xml+rss
        application/atom+xml
        image/svg+xml;
    
    server {
        listen       80;
        server_name  localhost;
        
        # Корневая директория
        root   /usr/share/nginx/html;
        index  index.html index.htm;
        
        # Основная страница
        location / {
            try_files $uri $uri/ /index.html;
            
            # CORS заголовки
            add_header Access-Control-Allow-Origin *;
            add_header Access-Control-Allow-Methods "GET, POST, OPTIONS";
            add_header Access-Control-Allow-Headers "Content-Type, Authorization";
        }
        
        # API для логов и статуса
        location /var/log/backup/ {
            alias /var/log/backup/;
            autoindex on;
            autoindex_format json;
            
            # CORS
            add_header Access-Control-Allow-Origin *;
            add_header Access-Control-Allow-Methods "GET, OPTIONS";
            
            # Правильные MIME типы
            location ~* \.json$ {
                add_header Content-Type application/json;
                add_header Access-Control-Allow-Origin *;
            }
            
            location ~* \.log$ {
                add_header Content-Type text/plain;
                add_header Access-Control-Allow-Origin *;
            }
        }
        
        # Прямой доступ к статусу
        location = /status.json {
            alias /var/log/backup/status.json;
            add_header Content-Type application/json;
            add_header Access-Control-Allow-Origin *;
            add_header Cache-Control "no-cache, no-store, must-revalidate";
        }
        
        # Прямой доступ к логам мониторинга
        location = /monitor.log {
            alias /var/log/backup/monitor.log;
            add_header Content-Type text/plain;
            add_header Access-Control-Allow-Origin *;
            add_header Cache-Control "no-cache, no-store, must-revalidate";
        }
        
        # Доступ к бэкапам (только чтение)
        location /backups/ {
            alias /backups/;
            autoindex on;
            autoindex_format json;
            add_header Access-Control-Allow-Origin *;
            
            # Запрещаем скачивание больших файлов через браузер
            location ~* \.(sql|gz)$ {
                add_header Content-Disposition "attachment";
            }
        }
        
        # API endpoints (заглушки для будущего расширения)
        location /api/ {
            add_header Content-Type application/json;
            add_header Access-Control-Allow-Origin *;
            return 501 '{"error":"API endpoint not implemented","message":"Use docker exec commands for manual operations"}';
        }
        
        # Healthcheck
        location /health {
            add_header Content-Type application/json;
            return 200 '{"status":"ok","service":"backup-monitor","timestamp":"$time_iso8601"}';
        }
        
        # Запрет доступа к системным файлам
        location ~ /\. {
            deny all;
            return 404;
        }
        
        # Кастомная страница ошибок
        error_page   500 502 503 504  /50x.html;
        location = /50x.html {
            root   /usr/share/nginx/html;
        }
        
        # Логирование для отладки
        access_log /var/log/nginx/backup-monitor.access.log;
        error_log  /var/log/nginx/backup-monitor.error.log;
    }
}
